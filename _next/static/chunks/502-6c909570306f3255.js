"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[502],{97626:function(i,a,t){t.d(a,{FA:function(){return l},My:function(){return r},Sp:function(){return n}});var e=t(2141);async function o(){try{let{data:{user:i},error:a}=await e.O.auth.getUser();if(a||!i)return null;return i.email||null}catch(i){return null}}async function n(i,a,t,n){try{let l=await o();if(!l)return console.warn("Foydalanuvchi email topilmadi, audit log yozilmadi"),!1;let{data:{user:r}}=await e.O.auth.getUser(),{data:s,error:m}=await e.O.from("audit_logs").insert({user_id:(null==r?void 0:r.id)||null,user_email:l,action:i,integration_id:a||null,integration_name:t,changes:n||null}).select();if(m)return console.error("Audit log yozishda xatolik:",m),console.error("Error details:",{code:m.code,message:m.message,details:m.details,hint:m.hint}),!1;return console.log("Audit log muvaffaqiyatli yozildi:",s),!0}catch(i){return console.error("Audit log yozishda xatolik:",i),!1}}async function l(){try{let{data:i,error:a}=await e.O.from("audit_logs").select("*").order("created_at",{ascending:!1});if(a)throw console.error("Audit log'larni o'qishda Supabase xatolik:",a),a;if(!i||0===i.length)return console.log("Audit log'lar topilmadi. Jadval mavjudmi?"),[];let t=i.map(i=>({id:i.id,userId:i.user_id,userEmail:i.user_email,action:i.action,integrationId:i.integration_id,integrationName:i.integration_name,changes:i.changes?"string"==typeof i.changes?JSON.parse(i.changes):i.changes:void 0,createdAt:i.created_at}));return console.log("Topilgan ".concat(t.length," ta audit log")),t}catch(a){var i;return console.error("Audit log'larni o'qishda xatolik:",a),((null==a?void 0:a.code)==="42P01"||(null==a?void 0:null===(i=a.message)||void 0===i?void 0:i.includes("does not exist")))&&console.error("'audit_logs' jadvali mavjud emas. Migration'ni ishga tushiring!"),[]}}function r(i,a){let t={};return["axborotTizimiNomi","integratsiyaUsuli","malumotNomi","tashkilotNomiVaShakli","asosiyMaqsad","normativHuquqiyHujjat","texnologikYoriknomaMavjudligi","malumotFormati","maqlumotAlmashishSharti","yangilanishDavriyligi","malumotHajmi","aloqaKanali","oxirgiUzatishVaqti","markaziyBankAloqa","hamkorAloqa","status","izoh"].forEach(e=>{let o=null==i?void 0:i[e],n=a[e];o!==n&&(t[e]={old:o,new:n})}),t}},20502:function(i,a,t){t.d(a,{v:function(){return r}});var e=t(2141),o=t(97626);let n=(i,a,t)=>{let e=null==a?void 0:a.map(i=>({id:i.id,name:i.name,columnKey:i.column_key,title:i.title,description:i.description,files:(null==t?void 0:t.filter(a=>a.tab_id===i.id).map(i=>({id:i.id,name:i.name,size:i.size,type:i.type,url:i.url||void 0})))||[],createdAt:i.created_at,updatedAt:i.updated_at}));return{id:i.id,sequentialNumber:i.sequential_number,axborotTizimiNomi:i.axborot_tizimi_nomi,integratsiyaUsuli:i.integratsiya_usuli,malumotNomi:i.malumot_nomi,tashkilotNomiVaShakli:i.tashkilot_nomi_va_shakli,asosiyMaqsad:i.asosiy_maqsad,normativHuquqiyHujjat:i.normativ_huquqiy_hujjat,texnologikYoriknomaMavjudligi:i.texnologik_yoriknoma_mavjudligi,malumotFormati:i.malumot_formati,maqlumotAlmashishSharti:i.maqlumot_almashish_sharti,yangilanishDavriyligi:i.yangilanish_davriyligi,malumotHajmi:i.malumot_hajmi,aloqaKanali:i.aloqa_kanali,oxirgiUzatishVaqti:i.oxirgi_uzatish_vaqti,markaziyBankAloqa:i.markaziy_bank_aloqa,hamkorAloqa:i.hamkor_aloqa,status:i.status,izoh:i.izoh,dynamicTabs:e,createdAt:i.created_at,updatedAt:i.updated_at}},l=i=>({axborot_tizimi_nomi:i.axborotTizimiNomi,integratsiya_usuli:i.integratsiyaUsuli,malumot_nomi:i.malumotNomi,tashkilot_nomi_va_shakli:i.tashkilotNomiVaShakli,asosiy_maqsad:i.asosiyMaqsad,normativ_huquqiy_hujjat:i.normativHuquqiyHujjat,texnologik_yoriknoma_mavjudligi:i.texnologikYoriknomaMavjudligi,malumot_formati:i.malumotFormati,maqlumot_almashish_sharti:i.maqlumotAlmashishSharti,yangilanish_davriyligi:i.yangilanishDavriyligi,malumot_hajmi:i.malumotHajmi,aloqa_kanali:i.aloqaKanali,oxirgi_uzatish_vaqti:i.oxirgiUzatishVaqti,markaziy_bank_aloqa:i.markaziyBankAloqa,hamkor_aloqa:i.hamkorAloqa,status:i.status,izoh:i.izoh}),r={getIntegrations:async()=>{try{let{data:i,error:a}=await e.O.from("integrations").select("*").order("created_at",{ascending:!1});if(a)throw a;if(!i||0===i.length)return[];let t=i.map(i=>i.id),{data:o}=await e.O.from("integration_tabs").select("*").in("integration_id",t),l=(null==o?void 0:o.map(i=>i.id))||[],{data:r}=l.length>0?await e.O.from("integration_files").select("*").in("tab_id",l):{data:null};return i.map(i=>n(i,(null==o?void 0:o.filter(a=>a.integration_id===i.id))||[],(null==r?void 0:r.filter(a=>null==o?void 0:o.some(t=>t.id===a.tab_id&&t.integration_id===i.id)))||[]))}catch(i){return console.error("Integratsiyalarni o'qishda xatolik:",i),[]}},getIntegration:async i=>{try{let{data:a,error:t}=await e.O.from("integrations").select("*").eq("id",i).single();if(t)throw t;if(!a)return null;let{data:o}=await e.O.from("integration_tabs").select("*").eq("integration_id",i),l=(null==o?void 0:o.map(i=>i.id))||[],{data:r}=l.length>0?await e.O.from("integration_files").select("*").in("tab_id",l):{data:null};return n(a,o||[],r||[])}catch(i){return console.error("Integratsiyani o'qishda xatolik:",i),null}},addIntegration:async i=>{try{let a=l(i),{data:t,error:n}=await e.O.from("integrations").insert(a).select().single();if(n)throw n;if(!t)throw Error("Integratsiya saqlanmadi");if(i.dynamicTabs&&i.dynamicTabs.length>0){let a=i.dynamicTabs.map(i=>({integration_id:t.id,name:i.name,column_key:i.columnKey,title:i.title,description:i.description})),{data:o,error:n}=await e.O.from("integration_tabs").insert(a).select();if(n)throw n;if(o){let a=[];if(i.dynamicTabs.forEach((i,t)=>{i.files&&i.files.length>0&&i.files.forEach(i=>{a.push({tab_id:o[t].id,name:i.name,size:i.size,type:i.type,url:i.url||null})})}),a.length>0){let{error:i}=await e.O.from("integration_files").insert(a);if(i)throw i}}}let s=await r.getIntegration(t.id);if(!s)throw Error("Integratsiya topilmadi");return await (0,o.Sp)("created",s.id,s.axborotTizimiNomi),s}catch(i){throw console.error("Integratsiya qo'shishda xatolik:",i),i}},updateIntegration:async(i,a)=>{try{let t={};void 0!==a.axborotTizimiNomi&&(t.axborot_tizimi_nomi=a.axborotTizimiNomi),void 0!==a.integratsiyaUsuli&&(t.integratsiya_usuli=a.integratsiyaUsuli),void 0!==a.malumotNomi&&(t.malumot_nomi=a.malumotNomi),void 0!==a.tashkilotNomiVaShakli&&(t.tashkilot_nomi_va_shakli=a.tashkilotNomiVaShakli),void 0!==a.asosiyMaqsad&&(t.asosiy_maqsad=a.asosiyMaqsad),void 0!==a.normativHuquqiyHujjat&&(t.normativ_huquqiy_hujjat=a.normativHuquqiyHujjat),void 0!==a.texnologikYoriknomaMavjudligi&&(t.texnologik_yoriknoma_mavjudligi=a.texnologikYoriknomaMavjudligi),void 0!==a.malumotFormati&&(t.malumot_formati=a.malumotFormati),void 0!==a.maqlumotAlmashishSharti&&(t.maqlumot_almashish_sharti=a.maqlumotAlmashishSharti),void 0!==a.yangilanishDavriyligi&&(t.yangilanish_davriyligi=a.yangilanishDavriyligi),void 0!==a.malumotHajmi&&(t.malumot_hajmi=a.malumotHajmi),void 0!==a.aloqaKanali&&(t.aloqa_kanali=a.aloqaKanali),void 0!==a.oxirgiUzatishVaqti&&(t.oxirgi_uzatish_vaqti=a.oxirgiUzatishVaqti),void 0!==a.markaziyBankAloqa&&(t.markaziy_bank_aloqa=a.markaziyBankAloqa),void 0!==a.hamkorAloqa&&(t.hamkor_aloqa=a.hamkorAloqa),void 0!==a.status&&(t.status=a.status),void 0!==a.izoh&&(t.izoh=a.izoh),t.updated_at=new Date().toISOString();let n=await r.getIntegration(i),{error:l}=await e.O.from("integrations").update(t).eq("id",i);if(l)throw l;if(void 0!==a.dynamicTabs){let{data:t}=await e.O.from("integration_tabs").select("id").eq("integration_id",i),o=(null==t?void 0:t.map(i=>i.id))||[];if(o.length>0){let{data:i}=await e.O.from("integration_files").select("id, tab_id").in("tab_id",o);[].push(...(null==i?void 0:i.map(i=>i.id))||[])}let n=[],l=[],r=a.dynamicTabs.map(i=>i.id).filter(i=>i&&!1===i.startsWith("tab_")),s=o.filter(i=>!r.includes(i));if(s.length>0){let{data:i}=await e.O.from("integration_files").select("id").in("tab_id",s);i&&i.length>0&&await e.O.from("integration_files").delete().in("id",i.map(i=>i.id)),await e.O.from("integration_tabs").delete().in("id",s)}for(let t of a.dynamicTabs){let a=t.id;if(!a||a.startsWith("tab_")){let{data:o,error:l}=await e.O.from("integration_tabs").insert({integration_id:i,name:t.name,column_key:t.columnKey,title:t.title||null,description:t.description||null}).select().single();if(l)throw l;a=o.id,n.push(a)}else{let{error:i}=await e.O.from("integration_tabs").update({name:t.name,column_key:t.columnKey,title:t.title||null,description:t.description||null,updated_at:new Date().toISOString()}).eq("id",a);if(i)throw i;n.push(a);let{data:o}=await e.O.from("integration_files").select("id").eq("tab_id",a),l=(null==o?void 0:o.map(i=>i.id))||[],r=t.files.map(i=>i.id).filter(i=>i&&!1===i.startsWith("file_")),s=l.filter(i=>!r.includes(i));s.length>0&&await e.O.from("integration_files").delete().in("id",s)}if(t.files&&t.files.length>0)for(let i of t.files)if(i.id&&!i.id.startsWith("file_")){let{error:a}=await e.O.from("integration_files").update({name:i.name,size:i.size,type:i.type,url:i.url||null}).eq("id",i.id);if(a)throw a;l.push(i.id)}else{let{data:t,error:o}=await e.O.from("integration_files").insert({tab_id:a,name:i.name,size:i.size,type:i.type,url:i.url||null}).select().single();if(o)throw o;t&&l.push(t.id)}}}let s=await r.getIntegration(i);if(s&&n){let i=(0,o.My)(n,s);await (0,o.Sp)("updated",s.id,s.axborotTizimiNomi,Object.keys(i).length>0?i:void 0)}return s}catch(i){throw console.error("Integratsiyani yangilashda xatolik:",i),i}},deleteIntegration:async i=>{try{let a=await r.getIntegration(i),t=(null==a?void 0:a.axborotTizimiNomi)||"Noma'lum",{data:n}=await e.O.from("integration_tabs").select("id").eq("integration_id",i);if(n&&n.length>0){let i=n.map(i=>i.id);await e.O.from("integration_files").delete().in("tab_id",i)}await e.O.from("integration_tabs").delete().eq("integration_id",i);let{error:l}=await e.O.from("integrations").delete().eq("id",i);if(l)throw l;return await (0,o.Sp)("deleted",i,t),!0}catch(i){return console.error("Integratsiyani o'chirishda xatolik:",i),!1}},addTabToIntegration:async(i,a)=>{try{let{data:t,error:o}=await e.O.from("integration_tabs").insert({integration_id:i,name:a.name,column_key:a.columnKey,title:a.title,description:a.description}).select().single();if(o)throw o;if(a.files&&a.files.length>0&&t){let i=a.files.map(i=>({tab_id:t.id,name:i.name,size:i.size,type:i.type,url:i.url||null}));await e.O.from("integration_files").insert(i)}return await r.getIntegration(i)}catch(i){return console.error("Tab qo'shishda xatolik:",i),null}},removeTabFromIntegration:async(i,a)=>{try{await e.O.from("integration_files").delete().eq("tab_id",a);let{error:t}=await e.O.from("integration_tabs").delete().eq("id",a);if(t)throw t;return await r.getIntegration(i)}catch(i){return console.error("Tab o'chirishda xatolik:",i),null}}}}}]);